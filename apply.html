<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ“‹ ç”³è«‹æˆç‚ºå€™é¸äºº</title>
  <style>
    body {
      font-family: "Segoe UI", "Noto Sans TC", sans-serif;
      background: #f0f4ff;
      margin: 0;
      padding: 2em 1em;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      background: white;
      padding: 2em;
      border-radius: 14px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 480px;
    }
    h1 {
      text-align: center;
      margin-bottom: 1em;
    }
    label {
      display: block;
      margin-top: 1em;
      font-weight: 600;
    }
    input[type="text"], textarea {
      width: 100%;
      padding: 0.6em;
      margin-top: 0.3em;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1em;
      resize: vertical;
    }
    textarea {
      min-height: 100px;
    }
    button {
      margin-top: 1.5em;
      width: 100%;
      padding: 0.9em;
      font-size: 1.1em;
      background-color: #5865f2;
      border: none;
      color: white;
      border-radius: 10px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #4752c4;
    }
    #status {
      margin-top: 1em;
      font-weight: bold;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“‹ ç”³è«‹æˆç‚ºå€™é¸äºº</h1>

    <form id="applyForm">
      <label for="name">ğŸ‘¤ å§“åï¼ˆå¿…å¡«ï¼‰</label>
      <input type="text" id="name" name="name" required placeholder="è«‹è¼¸å…¥å§“å" />

      <label for="statement">ğŸ“£ æ”¿è¦‹ï¼ˆå¿…å¡«ï¼‰</label>
      <textarea id="statement" name="statement" required placeholder="è«‹ç°¡è¿°æ‚¨çš„æ”¿è¦‹"></textarea>

      <label for="avatarURL">ğŸ–¼ï¸ é ­åƒåœ–ç‰‡ç¶²å€ï¼ˆé¸å¡«ï¼‰</label>
      <input type="text" id="avatarURL" name="avatarURL" placeholder="å¯è²¼ä¸Šé ­åƒåœ–ç‰‡é€£çµ" />

      <button type="submit">ğŸš€ é€å‡ºç”³è«‹</button>
    </form>

    <div id="status">ğŸ”„ æ­£åœ¨ç­‰å¾… Discord ç™»å…¥èªè­‰...</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, set, push } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDIkIruhzBiNn_rLTt7D6-2vsLw8r44P48",
      authDomain: "election-system-136e4.firebaseapp.com",
      databaseURL: "https://election-system-136e4-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "election-system-136e4",
      storageBucket: "election-system-136e4.firebasestorage.app",
      messagingSenderId: "956688105056",
      appId: "1:956688105056:web:ed7791b53b3fd1168dcd05"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // è§£æ Discord access_token
    const hash = new URLSearchParams(window.location.hash.substring(1));
    const accessToken = hash.get("access_token");

    const statusEl = document.getElementById("status");
    const form = document.getElementById("applyForm");

    if (!accessToken) {
      statusEl.textContent = "âŒ å°šæœªç™»å…¥ Discordï¼Œè«‹å…ˆå›é¦–é ç™»å…¥";
      form.style.display = "none";
    } else {
      // å–å¾— Discord ç”¨æˆ¶è³‡æ–™
      fetch("https://discord.com/api/users/@me", {
        headers: { Authorization: `Bearer ${accessToken}` }
      })
        .then(res => res.json())
        .then(user => {
          statusEl.textContent = `âœ… æ­¡è¿ ${user.username}ï¼Œè«‹å¡«å¯«ç”³è«‹è¡¨`;
          form.style.display = "block";

          // è¡¨å–®é€å‡ºäº‹ä»¶
          form.addEventListener("submit", async (e) => {
            e.preventDefault();
            statusEl.textContent = "â³ ç”³è«‹ä¸­ï¼Œè«‹ç¨å€™...";

            const name = form.name.value.trim();
            const statement = form.statement.value.trim();
            const avatarURL = form.avatarURL.value.trim();

            if (!name || !statement) {
              statusEl.textContent = "â— è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½";
              return;
            }

            // æ¨é€è³‡æ–™åˆ° /applications_pending
            const appRef = ref(db, "applications_pending");
            const newAppRef = push(appRef);

            try {
              await set(newAppRef, {
                name,
                statement,
                avatarURL: avatarURL || "",
                submittedBy: user.id,
                createdAt: Date.now()
              });
              statusEl.textContent = "ğŸ‰ ç”³è«‹é€å‡ºæˆåŠŸï¼Œç­‰å¾…ç®¡ç†å“¡å¯©æ ¸ï¼";
              form.reset();
            } catch (error) {
              statusEl.textContent = "âŒ ç”³è«‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
            }
          });
        })
        .catch(() => {
          statusEl.textContent = "âŒ Discord èªè­‰å¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥";
          form.style.display = "none";
        });
    }
  </script>
</body>
</html>
