<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ—³ï¸ æŠ•ç¥¨é é¢</title>
  <style>
    body {
      font-family: "Segoe UI", "Noto Sans TC", sans-serif;
      background: #f4f6fa;
      margin: 0;
      padding: 2em 1em;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      font-size: 2em;
      margin-bottom: 1em;
    }

    .container {
      width: 100%;
      max-width: 700px;
    }

    .candidate {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      padding: 1.2em;
      margin-bottom: 1.5em;
      display: flex;
      gap: 1em;
      align-items: flex-start;
    }

    .candidate img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
    }

    .candidate-info {
      flex: 1;
    }

    .candidate-info h3 {
      margin: 0 0 0.3em;
    }

    .candidate-info p {
      margin: 0.2em 0;
    }

    .vote-btn {
      margin-top: 1em;
      padding: 0.6em 1.2em;
      font-size: 1em;
      background-color: #4caf50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .vote-btn[disabled] {
      background-color: #aaa;
      cursor: not-allowed;
    }

    #status {
      margin-bottom: 1em;
      color: #d32f2f;
      font-weight: bold;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>ğŸ—³ï¸ é¸å‡ºä½ æ”¯æŒçš„å€™é¸äºº</h1>
  <div id="status">ğŸ”„ æ­£åœ¨è¼‰å…¥å€™é¸äººèˆ‡é©—è­‰èº«åˆ†...</div>
  <div class="container" id="candidate-list"></div>

  <script type="module">
    // Firebase å¥—ä»¶
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, get, set, child, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDIkIruhzBiNn_rLTt7D6-2vsLw8r44P48",
      authDomain: "election-system-136e4.firebaseapp.com",
      databaseURL: "https://election-system-136e4-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "election-system-136e4",
      storageBucket: "election-system-136e4.firebasestorage.app",
      messagingSenderId: "956688105056",
      appId: "1:956688105056:web:ed7791b53b3fd1168dcd05"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const statusEl = document.getElementById("status");
    const listEl = document.getElementById("candidate-list");

    let discordUser = null;
    let hasVoted = false;
    let deadlinePassed = false;

    // è§£æ access token
    const hash = new URLSearchParams(window.location.hash.substring(1));
    const accessToken = hash.get("access_token");

    if (!accessToken) {
      statusEl.textContent = "âŒ æœªç™»å…¥ Discordï¼Œè«‹å…ˆå›é¦–é ç™»å…¥";
    } else {
      // å‘¼å« Discord API å–å¾—ä½¿ç”¨è€…è³‡æ–™
      fetch("https://discord.com/api/users/@me", {
        headers: { Authorization: `Bearer ${accessToken}` },
      })
        .then(res => res.json())
        .then(async user => {
          discordUser = user;
          const uid = user.id;

          // æª¢æŸ¥æŠ•ç¥¨æˆªæ­¢æ™‚é–“
          const deadlineSnap = await get(ref(db, "settings/voteDeadline"));
          const deadline = deadlineSnap.exists() ? deadlineSnap.val() : 0;
          if (Date.now() > deadline) {
            statusEl.textContent = "â° æŠ•ç¥¨å·²æˆªæ­¢ï¼Œç„¡æ³•å†æŠ•ç¥¨ã€‚";
            deadlinePassed = true;
          }

          // æª¢æŸ¥æ˜¯å¦å·²æŠ•ç¥¨
          const userSnap = await get(ref(db, `users/${uid}`));
          if (userSnap.exists() && userSnap.val().hasVoted) {
            hasVoted = true;
            statusEl.textContent = "âœ… ä½ å·²æŠ•ç¥¨çµ¦ï¼š" + userSnap.val().votedFor;
          } else if (!deadlinePassed) {
            statusEl.textContent = "âœ… èº«åˆ†é©—è­‰æˆåŠŸï¼Œè«‹é¸æ“‡ä½ æ”¯æŒçš„å€™é¸äººï¼š";
          }

          // é¡¯ç¤ºå€™é¸äººåˆ—è¡¨
          const candSnap = await get(ref(db, "candidates"));
          if (candSnap.exists()) {
            const data = candSnap.val();
            Object.entries(data).forEach(([id, info]) => {
              if (!info.approved) return;

              const div = document.createElement("div");
              div.className = "candidate";
              div.innerHTML = `
                <img src="${info.avatarURL || 'https://cdn-icons-png.flaticon.com/512/147/147142.png'}" alt="é ­åƒ">
                <div class="candidate-info">
                  <h3>ğŸ‘¤ ${info.name}</h3>
                  <p>ğŸ“£ ${info.statement || "ï¼ˆæœªå¡«å¯«æ”¿è¦‹ï¼‰"}</p>
                  <button class="vote-btn" ${hasVoted || deadlinePassed ? "disabled" : ""}>ğŸ—³ï¸ æŠ•é€™ä½</button>
                </div>
              `;
              const btn = div.querySelector("button");
              btn.addEventListener("click", async () => {
                if (confirm(`ç¢ºå®šè¦æŠ•çµ¦ ${info.name} å—ï¼Ÿï¼ˆåªèƒ½æŠ•ä¸€æ¬¡ï¼‰`)) {
                  await update(ref(db, `users/${uid}`), {
                    hasVoted: true,
                    votedFor: info.name
                  });
                  statusEl.textContent = `ğŸ‰ å·²æˆåŠŸæŠ•ç¥¨çµ¦ï¼š${info.name}`;
                  document.querySelectorAll(".vote-btn").forEach(b => b.disabled = true);
                }
              });
              listEl.appendChild(div);
            });
          } else {
            statusEl.textContent = "â— æ‰¾ä¸åˆ°å€™é¸äººåå–®";
          }
        })
        .catch(() => {
          statusEl.textContent = "âŒ Discord ç™»å…¥å¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥";
        });
    }
  </script>
</body>
</html>
