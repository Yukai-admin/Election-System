<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ› ï¸ ç®¡ç†å¾Œå°</title>
  <style>
    body {
      font-family: "Segoe UI", "Noto Sans TC", sans-serif;
      background: #f9fafb;
      padding: 2em 1em;
      max-width: 800px;
      margin: auto;
      color: #222;
    }
    h1, h2 {
      text-align: center;
    }
    button {
      cursor: pointer;
      border: none;
      padding: 0.5em 1em;
      border-radius: 6px;
      font-size: 1em;
      margin: 0 0.3em;
      transition: background-color 0.3s;
    }
    .btn-approve {
      background-color: #4caf50;
      color: white;
    }
    .btn-approve:hover {
      background-color: #388e3c;
    }
    .btn-reject {
      background-color: #f44336;
      color: white;
    }
    .btn-reject:hover {
      background-color: #d32f2f;
    }
    .btn-save {
      background-color: #1976d2;
      color: white;
      margin-top: 0.5em;
      display: inline-block;
    }
    .btn-save:hover {
      background-color: #115293;
    }
    .candidate, .setting {
      background: white;
      padding: 1em;
      border-radius: 12px;
      margin-bottom: 1em;
      box-shadow: 0 3px 12px rgba(0,0,0,0.1);
    }
    .candidate img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      vertical-align: middle;
      margin-right: 1em;
    }
    .candidate-info {
      display: inline-block;
      vertical-align: middle;
      max-width: 600px;
    }
    label {
      font-weight: 600;
      display: block;
      margin-top: 1em;
    }
    input[type="text"], textarea, input[type="datetime-local"] {
      width: 100%;
      padding: 0.6em;
      margin-top: 0.3em;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 1em;
      resize: vertical;
    }
    #status {
      text-align: center;
      margin-bottom: 1em;
      font-weight: bold;
      color: #1976d2;
    }
  </style>
</head>
<body>
  <h1>ğŸ› ï¸ ç®¡ç†å¾Œå°</h1>

  <div id="status">ğŸ”„ è«‹å…ˆç™»å…¥ Discord ç®¡ç†å“¡èº«åˆ†</div>

  <section class="setting">
    <h2>ğŸ“¢ å…¬å‘Šç®¡ç†</h2>
    <textarea id="announcement" rows="3" placeholder="è«‹è¼¸å…¥å…¬å‘Šå…§å®¹..."></textarea>
    <button class="btn-save" id="saveAnnouncement">ğŸ’¾ å„²å­˜å…¬å‘Š</button>
  </section>

  <section class="setting">
    <h2>â° æŠ•ç¥¨æˆªæ­¢æ™‚é–“è¨­å®š</h2>
    <input type="datetime-local" id="voteDeadline" />
    <button class="btn-save" id="saveDeadline">ğŸ’¾ å„²å­˜æˆªæ­¢æ™‚é–“</button>
  </section>

  <section>
    <h2>ğŸ“‹ å¾…å¯©æ ¸å€™é¸äººç”³è«‹</h2>
    <div id="pendingList">ğŸ”„ è¼‰å…¥ä¸­...</div>
  </section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, get, set, remove, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDIkIruhzBiNn_rLTt7D6-2vsLw8r44P48",
      authDomain: "election-system-136e4.firebaseapp.com",
      databaseURL: "https://election-system-136e4-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "election-system-136e4",
      storageBucket: "election-system-136e4.firebasestorage.app",
      messagingSenderId: "956688105056",
      appId: "1:956688105056:web:ed7791b53b3fd1168dcd05"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const statusEl = document.getElementById("status");
    const pendingListEl = document.getElementById("pendingList");
    const announcementEl = document.getElementById("announcement");
    const saveAnnouncementBtn = document.getElementById("saveAnnouncement");
    const voteDeadlineEl = document.getElementById("voteDeadline");
    const saveDeadlineBtn = document.getElementById("saveDeadline");

    let discordUser = null;
    const CLIENT_ID = "1399942836383781025";
    const REDIRECT_URI = window.location.origin + "/Election-System/admin.html";
    const SCOPE = "identify";

    // Discord OAuth Token è§£æ
    const hash = new URLSearchParams(window.location.hash.substring(1));
    const accessToken = hash.get("access_token");

    if (!accessToken) {
      statusEl.textContent = "âŒ å°šæœªç™»å…¥ Discordï¼Œè«‹å…ˆç™»å…¥ç®¡ç†å“¡èº«åˆ†";
      redirectToLogin();
    } else {
      // å–å¾— Discord ä½¿ç”¨è€…è³‡æ–™
      fetch("https://discord.com/api/users/@me", {
        headers: { Authorization: `Bearer ${accessToken}` }
      })
        .then(res => res.json())
        .then(user => {
          discordUser = user;
          // é€™è£¡ç¤ºç¯„ç°¡å–®ç®¡ç†å“¡åˆ¤æ–· (å¯ç”¨å¯¦éš› Discord ID åˆ¤æ–·)
          const adminIDs = ["ä½ çš„DiscordID1", "ä½ çš„DiscordID2"]; // <- è«‹æ”¹æˆä½ çš„ Discord ID
          if (!adminIDs.includes(user.id)) {
            statusEl.textContent = "âŒ æ‚¨ä¸æ˜¯ç®¡ç†å“¡ï¼Œç„¡æ³•ä½¿ç”¨æ­¤é é¢";
            return;
          }
          statusEl.textContent = `âœ… æ­¡è¿ç®¡ç†å“¡ ${user.username}`;
          initAdminPanel();
        })
        .catch(() => {
          statusEl.textContent = "âŒ Discord èªè­‰å¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥";
          redirectToLogin();
        });
    }

    function redirectToLogin() {
      const loginUrl = `https://discord.com/api/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=${SCOPE}`;
      setTimeout(() => window.location.href = loginUrl, 3000);
    }

    // åˆå§‹åŒ–ç®¡ç†é é¢åŠŸèƒ½
    async function initAdminPanel() {
      await loadAnnouncement();
      await loadVoteDeadline();
      await loadPendingApplications();

      saveAnnouncementBtn.addEventListener("click", saveAnnouncement);
      saveDeadlineBtn.addEventListener("click", saveDeadline);
    }

    // è¼‰å…¥å…¬å‘Š
    async function loadAnnouncement() {
      const snap = await get(ref(db, "settings/announcement"));
      announcementEl.value = snap.exists() ? snap.val() : "";
    }

    // å„²å­˜å…¬å‘Š
    async function saveAnnouncement() {
      try {
        await set(ref(db, "settings/announcement"), announcementEl.value.trim());
        alert("å…¬å‘Šå·²å„²å­˜ï¼");
      } catch {
        alert("å…¬å‘Šå„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
      }
    }

    // è¼‰å…¥æŠ•ç¥¨æˆªæ­¢æ™‚é–“
    async function loadVoteDeadline() {
      const snap = await get(ref(db, "settings/voteDeadline"));
      if (snap.exists()) {
        const timestamp = snap.val();
        const date = new Date(timestamp);
        voteDeadlineEl.value = date.toISOString().slice(0,16); // yyyy-MM-ddTHH:mm
      }
    }

    // å„²å­˜æˆªæ­¢æ™‚é–“
    async function saveDeadline() {
      if (!voteDeadlineEl.value) {
        alert("è«‹é¸æ“‡æœ‰æ•ˆçš„æˆªæ­¢æ™‚é–“");
        return;
      }
      const timestamp = new Date(voteDeadlineEl.value).getTime();
      try {
        await set(ref(db, "settings/voteDeadline"), timestamp);
        alert("æˆªæ­¢æ™‚é–“å·²å„²å­˜ï¼");
      } catch {
        alert("æˆªæ­¢æ™‚é–“å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
      }
    }

    // è¼‰å…¥å¾…å¯©æ ¸ç”³è«‹
    async function loadPendingApplications() {
      const snap = await get(ref(db, "applications_pending"));
      pendingListEl.innerHTML = "";
      if (!snap.exists()) {
        pendingListEl.textContent = "ç›®å‰ç„¡å¾…å¯©æ ¸ç”³è«‹";
        return;
      }

      const apps = snap.val();
      for (const [key, app] of Object.entries(apps)) {
        const div = document.createElement("div");
        div.className = "candidate";

        div.innerHTML = `
          <img src="${app.avatarURL || 'https://cdn-icons-png.flaticon.com/512/147/147142.png'}" alt="é ­åƒ" />
          <div class="candidate-info">
            <h3>${app.name}</h3>
            <p>ğŸ“£ ${app.statement}</p>
            <p>ğŸ”‘ ç”³è«‹è€… ID: ${app.submittedBy}</p>
            <div style="margin-top: 0.8em;">
              <button class="btn-approve">âœ… é€šé</button>
              <button class="btn-reject">âŒ æ‹’çµ•</button>
            </div>
          </div>
        `;

        const btnApprove = div.querySelector(".btn-approve");
        const btnReject = div.querySelector(".btn-reject");

        btnApprove.onclick = async () => {
          try {
            // å¯©æ ¸é€šéï¼šåŠ å…¥ candidatesï¼Œåˆªé™¤ç”³è«‹
            await update(ref(db, `candidates/${key}`), {
              ...app,
              approved: true
            });
            await remove(ref(db, `applications_pending/${key}`));
            alert(`âœ… é€šé ${app.name}`);
            div.remove();
          } catch {
            alert("é€šéæ“ä½œå¤±æ•—");
          }
        };

        btnReject.onclick = async () => {
          if (confirm(`ç¢ºå®šæ‹’çµ• ${app.name} çš„ç”³è«‹ï¼Ÿ`)) {
            try {
              await remove(ref(db, `applications_pending/${key}`));
              alert(`âŒ å·²æ‹’çµ• ${app.name}`);
              div.remove();
            } catch {
              alert("æ‹’çµ•æ“ä½œå¤±æ•—");
            }
          }
        };

        pendingListEl.appendChild(div);
      }
    }
  </script>
</body>
</html>
